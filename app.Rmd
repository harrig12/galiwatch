---
title: "GaliWatch Weather Dashboard"
output: 
  flexdashboard::flex_dashboard:
    theme: readable
    orientation: rows
    css: static/extra.css
runtime: shiny
---

```{r global, include=FALSE, warning=FALSE}
# load data in 'global' chunk so it can be shared by all users of the dashboard
library(lubridate)
library(openair)
library(flexdashboard)
library(dplyr)
library(googlesheets4)
library(plotly)

# retrieve and parse data
sheets_deauth()

read_sheet("1HfkGvlkrDyYX0YKIF4nFMhzwl-mJ-f4K2nVFsyOi6v8", sheet = 'tiny sample',
           col_types = paste0(c("c", "c", rep("n", 24)),collapse = '')) %>%
  mutate(Date = ymd(Date), Time = hms(Time)) -> weather
```


Column {.sidebar}
-----------------------------------------------------------------------

Weather data collected as part of [Operation Galiwatch](https://harrig12.github.io/galiwatch/)

```{r}
dateInput("last_day", label = "Pick Day", value = now(), 
          min = min(weather$Date, na.rm = T) + 7, max = max(weather$Date, na.rm = T))

sliderInput("n_days", label = "How many historical days to show?",
            min = 3, max = 10, value = 7, step = 1)
```

Row {data-height=400}
-------------------------------------
    
### Temperature

```{r}
renderPlotly({

weather %>%
  filter(Date <= input$last_day, Date >= (input$last_day-input$n_days)) %>%
  tail(input$n_days) %>%
  plot_ly(x = ~Date, type = 'scatter', mode = 'lines+markers', colors = "Set2",
          y = ~`Indoor Temperature F`, name = 'Indoor Temp') %>%
  add_trace(y = ~`Outdoor Temperature F`, name = 'Outdoor Temp') %>%
  add_trace(y = ~`Dew Point`, name = 'Dew Point') %>%
  add_trace(y = ~`Feels like`, name = 'Feels Like') %>%
  layout(yaxis = list(title = 'Temperature (F)'), hovermode = "x unified") 
  
})
``` 

### Data sparsity

```{r}

renderText({ 
    sparce <- weather %>% filter(Date <= input$last_day, Date >= (input$last_day-input$n_days))
    paste("In selected timeframe, data was picked up for ",  sum((dim(sparce)[1] - colSums(is.na(sparce))) != 0)," out of 24 sensors.")
})

renderGauge({

mean_missing <- weather %>%
  filter(Date <= input$last_day, Date >= (input$last_day-input$n_days)) %>%
  is.na() %>% rowSums() %>% max()

gauge(mean_missing, 
      gaugeSectors(success = c(0, 0.3 * dim(weather)[2]), 
                   warning = c(0.3 * dim(weather)[2], 0.6 * dim(weather)[2]),
                   danger = c(0.6 * dim(weather)[2], dim(weather)[2])),
        min = 0, max = 100)
})
```

Row
-------------------------------------
   
### Humidity
    
```{r}
renderPlotly({

weather %>%
  filter(Date < input$last_day, Date > (input$last_day -input$n_days)) %>%
  tail(input$n_days) %>%
  plot_ly(x = ~Date, type = 'scatter', mode = 'lines+markers', colors = "Set2",
          y = ~`Indoor Humidity %`, name = 'Indoor Humidity') %>%
  add_trace(y = ~`Outdoor Humidity %`, name = 'Outdoor Humidity') %>%
  layout(yaxis = list(title = 'Humidity (%)'), hovermode = "x unified") 
  
})
```

### Wind rose

```{r}
renderPlot({
  
weather %>%
  filter(Date < input$last_day, Date > (input$last_day -input$n_days)) %>%
  windRose(ws = "Wind Speed(mph)" , wd = "wind direction(Degree)")

})
```

